{"version":3,"sources":["route.js"],"names":["layui","define","exports","_viewBoxGlobal","this","config","Route","routerViewId","undefined","name","routes","router","location","hash","pathname","href","split","utils","localStorage","setItem","getItem","$","_","layer","jquery","_win","prototype","set","options","setRoutes","that","defaults","forEach","item","extend","getTime","random","window","off","on","onChanged","getRoutes","getRoute","route","c","find","r","component","length","render","renderTarget","callback","_viewBox","NProgress","loadIndex","load","start","randomCode","_view","parent","append","viewId","remove","done","close","isFunction","cb","beforeRender","h","currBoxHeight","height","join","data","html","path","errorMsg","p","params","value","substr","indexOf","index","kv","key"],"mappings":";cAAAA,MAAMC,OAAO,CAAC,QAAS,SAAU,SAAU,YAAa,SAAU,SAASC,GAUrEC,SAAAA,IAGFC,KAAKC,OAAS,CADZC,KAAAA,gBACFC,kBAAcC,EACZC,kBAAMD,EACND,OAAAA,IAEAG,IAAAA,EAAQV,MAAAW,OAAAC,SAAAC,MAJIT,KAAdU,cAAAN,IAAAG,EAAAI,KAAA,IAAAJ,EAAAI,KAAAC,MAAA,KAAA,GAMAZ,KAAIO,QAASX,QAlBf,IAAIiB,EAAQjB,MAAMiB,MADpBjB,EAAciB,EAASC,aACrBC,EAAYnB,EAAZmB,QAAAC,EACEF,EAAqBA,QADvBG,EAEEF,MAAAA,OAFFG,EAGEF,MAAAA,OAHFG,EAIMvB,MAAMwB,MAJZC,EAKMzB,EAAAA,QAEJyB,OAPFjB,EA0BAF,EAAMoB,UAAUC,IAAM,SAASC,GAC7B,OADFtB,EAAAA,QAAMoB,EACOtB,KADSC,OAAAuB,GACTxB,MAQbE,EAAMoB,UAAUG,UAAY,SAASD,GACnC,IAAIE,EAAO1B,KADbE,EAAMoB,KAAUG,EAAhBpB,MAA4BqB,EAASF,OAATnB,KAC1BqB,EAAIA,OAAOrB,KAAXmB,EAAAnB,KACAmB,IAAAA,EAAeA,CACfE,OAAKzB,IAgBF,OAdDK,EAAAA,QAAAA,EAAQqB,EAAAH,GADKN,EAAfU,QAAAD,EAAArB,OAAA,SAAAuB,GAGEC,EAAAA,IAAO,IAAMH,MAAfI,UAAA,GAAAb,EAAAc,OAAA,IAAA,QAGCjB,EAFDY,EAAAtB,KAAAsB,EAAArB,QAGAW,EAAAgB,QAAAC,IAAA,YAAAC,GAAA,WAAA,WAEEF,EAAQC,WAAIV,EAAeY,WAC3BZ,EAAAY,YAEEZ,EAAAA,WAGDE,GAOLxB,EAAMoB,UAAUe,UAAY,WAC1B,OAAOrB,EAAQhB,KAAKC,OAAOI,OAM7BH,EAAMoB,UAAUgB,SAAW,SAAS7B,GAClC,IADIa,EACOtB,KADGsC,UACHtC,KADcC,OAAAI,MACzB,GAAIqB,MAAAA,EAAJ,CAGEjB,EAAAA,GAAOL,SAAPK,KACD,IAAA8B,EAAA3C,MAAAW,OAAAE,GACDA,GAAAA,MAAAA,EAAAA,CAGE,IAAAE,EAAOP,EAAAA,KAAPQ,MAAA,KACD4B,EAAA3B,EAAA4B,KAAAnC,EAAA,SAAAoC,GACD,OAAI/B,EAAO4B,OAAM5B,EAAKC,KAEpB,YAAO8B,IAAPF,GAGA,EAAA7B,EAAO6B,SACRA,EAAAG,WAAA,IAAAhC,EAAA,GACD6B,EAAI7B,MAAKiC,IAASjC,EAAG,IANrB6B,KAkBFtC,EAAMoB,UAAUuB,OAAS,SAASpC,EAAMqC,EAAcC,GACpD,IAAIrB,EAAO1B,KADbE,EAAMoB,EAAUuB,OACdG,OAAW5C,EAAX6C,UAEED,QACF,IAAAE,EAAA/B,EAAAgC,KAAA,GACAF,EAAUG,EAAVC,aACA,GAAIH,GAAJ,EAAgB/B,EAAhByB,OACAI,EAAanC,MACTiC,CACFE,IAAAA,OAAA5C,IAAW0C,EAAAA,aADb7B,EAAA,eAEOA,EAAA,eAAAhB,EAAAE,cAGL,EAAAmD,EAAAV,SAEEU,EAAAC,SAAAC,OAAA,YAAAC,EAAA,YACAH,EAAMC,SACND,EAAMI,EAAN,IAAAD,GACAT,EAAaA,QAIjB5C,IAAA4C,IACAA,EAAIA,GAEH,IAAAT,EAAAb,EAAAY,SAAA7B,GA2FH,SAAI8B,IAEJzC,UAAQ6D,OAzNVT,GAAA/B,EAAAyC,MAAAV,GAgMMrC,EAAMgD,WAAWd,IAAaA,IAEhC,YAhCMC,IAAAA,GACAc,mBAAAA,EAAAA,eACAvB,EAAAtC,EAAA8D,aAAAxB,IAGAA,EAAIyB,QAYJF,EAAAA,KAAAA,gBAAAA,EAAAA,UAAAA,cAAAA,EAAAA,sCAEHzC,EAAAc,GAAA,SAAA,WApCH,IAqCO8B,EAAAhD,EAAA,eAAAiD,SACLlB,EAAAA,kBAA0BmB,EAA1B,KAAAD,OAAAD,EAAA,KACAhB,SAEDa,KAEDjD,EAASiD,UAAKvB,EAAAI,UAAA,SAAAyB,GACZpB,EAAAqB,KAAAD,GACAnB,IAEApC,EAAMgD,YAAWd,EAAjB1C,KAA8B0C,IAA9BR,EAAA+B,OACD,SAAAC,GACD,IAAO7C,EAAP,CA/FF,4BAiGA,0BA1BU,+BACA,+BA4BJJ,EACAf,SACAA,SACAI,SACIA,UACJA,KAAS6D,IACTC,EAAW7D,KAAFoD,GACTI,QAIFpB,EAAI0B,KArFWpC,CACjB,4BAmBA,4BACE,mCACEC,gCACD,kDACD,sCACA,wCACE,oEACAS,sEACA,iFACA3B,mBACE,iBACAJ,kDACD,eAhBH,aAkBE6C,WACD,UAkDDK,KAAA,KACAC,UAAAT,OAJFT,GAAA/B,EAAAyC,MAAAV,IAbOxB,GAKTxB,EAAMoB,UAAUmD,OAAS,WACvB,IAAIlE,EAASX,MAAMW,SACnB,QAAoBH,IAAhBG,EAAOI,KAAoB,OAAO,KACtC,IAAIA,EAAOJ,EAAOI,KACd6D,EAAI7D,EAAKgE,OAAOhE,EAAKiE,QAAQ,KAAO,GACxC,GAAIjE,IAAS6D,EAAG,OAAO,KACvB,IAAIC,EAASD,EAAE5D,MAAM,KACjBwD,EAAO,GAOX,OANAlD,EAAEU,QAAQ6C,EAAQ,SAAS5C,EAAMgD,GAC/B,IAAIC,EAAKjD,EAAKjB,MAAM,KAChBmE,EAAMD,EAAG,GACTJ,EAAQI,EAAG,GACfV,EAAKW,GAAOL,IAEPN,GAITtE,EAAQ,QAFI,IAAII","file":"route.js","sourcesContent":["layui.define(['utils', 'jquery', 'lodash', 'nprogress', 'layer'], function(exports) {\r\n  var utils = layui.utils,\r\n    localStorage = utils.localStorage,\r\n    setItem = localStorage.setItem,\r\n    getItem = localStorage.getItem,\r\n    $ = layui.jquery,\r\n    _ = layui.lodash,\r\n    layer = layui.layer,\r\n    _win = $(window);\r\n\r\n  var _viewBoxGlobal = undefined;\r\n\r\n  var Route = function() {\r\n    this.config = {\r\n      name: 'KITADMINROUTE', // 这个不能改，可能会出问题。\r\n      routerViewId: undefined,\r\n      beforeRender: undefined,\r\n      routes: []\r\n    };\r\n    var router = layui.router(location.hash)\r\n    this.pathname = router.href === undefined ? '/' : router.href.split('?')[0];\r\n    this.version = '1.2.3';\r\n  };\r\n  /**\r\n   * 设置\r\n   * @param {Object} options \r\n   */\r\n  Route.prototype.set = function(options) {\r\n    var that = this;\r\n    $.extend(true, that.config, options);\r\n    return that;\r\n  };\r\n  /**\r\n   * 设置路由\r\n   * @param {*} options \r\n   */\r\n  Route.prototype.setRoutes = function(options) {\r\n    var that = this;\r\n    options.name = options.name || that.config.name;\r\n    that.config.name = options.name;\r\n    var defaults = {\r\n      routes: []\r\n    };\r\n    $.extend(true, defaults, options);\r\n    _.forEach(defaults.routes, function(item) {\r\n      item.id = new Date().getTime() + '' + _.random(1000, 9999);\r\n    });\r\n    // 缓存到本地\r\n    setItem(defaults.name, defaults.routes);\r\n    $(window).off('popstate').on('popstate', function() {\r\n      // 是否由外部处理\r\n      if (utils.isFunction(options.onChanged)) {\r\n        options.onChanged();\r\n      } else {\r\n        that.render();\r\n      }\r\n    });\r\n    return that;\r\n  };\r\n  /**\r\n   * 获取路由\r\n   */\r\n  Route.prototype.getRoutes = function() {\r\n    return getItem(this.config.name);\r\n  };\r\n  /**\r\n   * 获取路由信息\r\n   * @param {*} hash \r\n   */\r\n  Route.prototype.getRoute = function(hash) {\r\n    var that = this;\r\n    var routes = that.getRoutes(that.config.name);\r\n    if (routes === null || routes === undefined) {\r\n      return undefined;\r\n    }\r\n    hash = hash || location.hash;\r\n    var route = layui.router(hash);\r\n    if(route===null || route===undefined){\r\n      return undefined;\r\n    }\r\n    var href = route.href.split('?');\r\n    var c = utils.find(routes, function(r) {\r\n      return r.path === href[0];\r\n    });\r\n    if (c === undefined) {\r\n      return c;\r\n    }\r\n    if (href.length > 1) {\r\n      c.component += '?' + href[1];\r\n      c.path += '?' + href[1];\r\n    }\r\n    return c;\r\n  };\r\n  /**\r\n   * 渲染页面\r\n   * @param {*} hash \r\n   * @param {*} renderTarget \r\n   * @param {*} callback \r\n   */\r\n  Route.prototype.render = function(hash, renderTarget, callback) {\r\n    var that = this,\r\n      config = that.config,\r\n      _viewBox = undefined;\r\n    // 开始\r\n    NProgress.start();\r\n    var loadIndex = layer.load(2);\r\n    var viewId = utils.randomCode();\r\n    if (renderTarget && renderTarget.length > 0) {\r\n      _viewBox = renderTarget;\r\n    } else {\r\n      var _view = config.routerViewId === undefined ?\r\n        $('router-view') : $('router-view#' + config.routerViewId + '');\r\n      // 如果 router-view 标签存在都创建渲染dom,覆盖原来的\r\n      if (_view.length > 0) {\r\n        // 获取id\r\n        _view.parent().append('<div id=\"' + viewId + '\"></div>');\r\n        _view.remove();\r\n        _viewBox = $('#' + viewId);\r\n        _viewBoxGlobal = _viewBox; //缓存一个全局容器 避免单页面的时候 _viewBox 为 undefined\r\n      }\r\n    }\r\n    // 如果是单页面则读取全局\r\n    if (_viewBox === undefined) {\r\n      _viewBox = _viewBoxGlobal;\r\n    }\r\n    var route = that.getRoute(hash);\r\n    var notFoundTpl = [\r\n      '<div class=\"layui-fluid\">',\r\n      '  <div class=\"layui-row\">',\r\n      '    <div class=\"layui-col-xs12\">',\r\n      '      <div class=\"layui-row\">',\r\n      '        <div class=\"layui-col-md4\">&nbsp;</div>',\r\n      '        <div class=\"layui-col-md4\">',\r\n      '          <div class=\"kit-exception\">',\r\n      '            <i class=\"layui-icon kit-exception-icon\">&#xe61c;</i>',\r\n      '            <h3 class=\"kit-exception-title\">:>404 抱歉，你访问的页面不存在</h3>',\r\n      '            <a href=\"javascript:history.back(-1);\" class=\"layui-btn\">返回上一页</a>',\r\n      '          </div>',\r\n      '        </div>',\r\n      '        <div class=\"layui-col-md4\">&nbsp;</div>',\r\n      '      </div>',\r\n      '    </div>',\r\n      '  </div>',\r\n      '</div>'\r\n    ];\r\n    if (route !== undefined) {\r\n      if (typeof config.beforeRender === 'function') {\r\n        route = config.beforeRender(route);\r\n      }\r\n      // 如果是iframe\r\n      if (route.iframe) {\r\n        // _viewBox.html('<div class=\"kit-body-wapper\"><iframe src=\"' + route.component + '\" style=\"height: 780px;\"></iframe></div>');\r\n        _viewBox.html('<iframe src=\"' + route.component + '\" data-id=\"' + viewId + '\" style=\"height: 780px;\"></iframe>');\r\n        // 自适应高度\r\n        _win.on('resize', function() {\r\n          var currBoxHeight = $('.layui-body').height(); //获取当前容器的高度\r\n          $('iframe[data-id=' + viewId + ']').height(currBoxHeight - 3);\r\n        }).resize();\r\n\r\n        cb();\r\n      } else {\r\n        utils.tplLoader(route.component, function(data) {\r\n          _viewBox.html(data);\r\n          cb();\r\n          // 设置浏览器地址显示\r\n          utils.setUrlState(route.name, '#' + route.path);\r\n        }, function(errorMsg) {\r\n          var h = [\r\n            '<div class=\"layui-fluid\">',\r\n            '<div class=\"layui-row\">',\r\n            '<div class=\"layui-col-xs12\">',\r\n            '<div class=\"kit-not-router\">',\r\n            errorMsg,\r\n            '</div>',\r\n            '</div>',\r\n            '</div>',\r\n            '</div>'\r\n          ].join('');\r\n          _viewBox.html(h);\r\n          cb();\r\n        });\r\n      }\r\n    } else {\r\n      _viewBox.html(notFoundTpl.join(''));\r\n      NProgress.done();\r\n      loadIndex && layer.close(loadIndex);\r\n    }\r\n\r\n    function cb() {\r\n      // 结束\r\n      NProgress.done();\r\n      loadIndex && layer.close(loadIndex);\r\n      utils.isFunction(callback) && callback();\r\n    }\r\n    return that;\r\n  };\r\n  /**\r\n   * 获取路由参数\r\n   */\r\n  Route.prototype.params = function() {\r\n    var router = layui.router();\r\n    if (router.href === undefined) return null;\r\n    var href = router.href;\r\n    var p = href.substr(href.indexOf('?') + 1);\r\n    if (href === p) return null;\r\n    var params = p.split('&');\r\n    var data = {};\r\n    _.forEach(params, function(item, index) {\r\n      var kv = item.split('=');\r\n      var key = kv[0];\r\n      var value = kv[1];\r\n      data[key] = value;\r\n    });\r\n    return data;\r\n  };\r\n  var route = new Route();\r\n  //输出router接口\r\n  exports('route', route);\r\n});"]}